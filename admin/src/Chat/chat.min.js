function chat_init(e){function t(e,t){switch(e){case"online":null===X&&(X=o(t),Q.publish("conectar",s()));break;case"conectar":null===U&&(U=n(t)),i(t);break;case"desconectar":d(t);break;case"changeStatus":c(t);break;case"message":m(t);break;case"readMessage":x(t);break;case"onError":u(t)}}function s(){var e={conectar:{userId:K.userId,status:"online"}};return JSON.stringify(e)}function n(e){var t=JSON.parse(e);return parseInt(t.sessionId)}function a(){return parseInt(U)}function o(e){try{$.ajax({url:K.url,data:{userId:K.userId,process:"selectUsers"},method:"POST",dataType:"JSON",success:function(t){null!==t&&(r(t),l(e))},error:function(e){console.log(e)}})}catch(t){console.log(t)}}function r(e){try{X=new Array;for(var t=0;t<e.length;t++){var s=new Object;s.sessionId=null,s.userId=e[t].userId,s.nome=e[t].nome,s.nick=e[t].nick,s.status="offline",s.button=null,s.i=null,s.badge=N(e[t].msgNotRead),s.alertMsg=null,s.chat={visible:!1,window:{_construct:!1,panel:null,header:null,title:null,body:null,footer:null,form:null,textarea:null,buttonSend:null,iconClose:null},message:[{from:null,text:null,read:null,data:null}]},X[parseInt(e[t].userId)]=s}}catch(n){console.log(n)}}function l(e){try{var t=JSON.parse(e),s=$(t).toArray();X.forEach(function(e){s.forEach(function(t){for(var s=0;s<t.length;s++)parseInt(e.userId)===parseInt(t[s].userId)&&(e.status=t[s].status,e.sessionId=t[s].sessionId)}),e.button=E(e),e.i=T(e.status)}),Y()}catch(n){console.log(n)}}function i(e){try{var t=JSON.parse(e),s=parseInt(t.userId);if(parseInt(U)!==parseInt(t.sessionId))if("offline"===t.status)d(e);else for(var n=0;n<K.optionsStatus.length;n++)if(K.optionsStatus[n].text===t.status){X[s].sessionId=t.sessionId,X[s].button.value=t.sessionId,X[s].status=t.status,X[s].i["class"]=K.optionsStatus[n].icon,X[s].i.className=K.optionsStatus[n].icon,X[s].i.classList=K.optionsStatus[n].icon,X[s].i.style.color=K.optionsStatus[n].color,X[s].i.title=K.optionsStatus[n].text;break}}catch(a){console.log(a)}}function c(e){try{var t=JSON.parse(e),s=parseInt(t.userId);if(parseInt(U)!==parseInt(t.sessionId)&&parseInt(X[s].sessionId)===parseInt(t.sessionId)){X[s].status=t.status;for(var n=0;n<K.optionsStatus.length;n++)if(K.optionsStatus[n].text===t.status){X[s].i["class"]=K.optionsStatus[n].icon,X[s].i.className=K.optionsStatus[n].icon,X[s].i.classList=K.optionsStatus[n].icon,X[s].i.style.color=K.optionsStatus[n].color,X[s].i.title=K.optionsStatus[n].text;break}}}catch(a){console.log(a)}}function d(e){try{var t=JSON.parse(e),s=parseInt(t.desconectar.userId);if(parseInt(K.userId)!==parseInt(t.desconectar.userId)&&parseInt(X[s].sessionId)===parseInt(t.desconectar.sessionId))for(var n=0;n<K.optionsStatus.length;n++)if(K.optionsStatus[n].text===t.desconectar.status){X[s].sessionId=null,X[s].i["class"]=K.optionsStatus[n].icon,X[s].i.className=K.optionsStatus[n].icon,X[s].i.classList=K.optionsStatus[n].icon,X[s].i.style.color=K.optionsStatus[n].color,X[s].i.title=K.optionsStatus[n].text;break}}catch(a){console.log(a)}}function u(e){try{var t=JSON.parse(e),s=parseInt(t.onError.userId);if(a()===parseInt(t.onError.oldSessionId)){Q.close(),X=null;var n="Usuário duplicado, sua conexão foi fechada !! Provavelmente este login está sendo usado em outro dispositivo.";z(n)}else if(parseInt(K.userId)!==parseInt(t.onError.userId)&&parseInt(X[s].sessionId)===parseInt(t.onError.oldSessionId)){X[s].sessionId=t.onError.sessionId,X[s].button.value=t.onError.sessionId;for(var o=0;o<K.optionsStatus.length;o++)t.onError.status===K.optionsStatus[o].text&&(X[s].i["class"]=K.optionsStatus[o].icon,X[s].i.className=K.optionsStatus[o].icon,X[s].i.classList=K.optionsStatus[o].icon,X[s].i.style.color=K.optionsStatus[o].color,X[s].i.title=K.optionsStatus[o].text)}}catch(n){console.log(n)}}function p(e){try{var t=parseInt(e.userId);X[t].chat.window._construct===!1?(X[t].chat.window.panel=L(e),X[t].chat.window.body=R(),X[t].chat.window.header=M(),X[t].chat.window.footer=B(),X[t].chat.window.title=J(e),X[t].chat.window.form=A(e),X[t].chat.window.iconClose=F(e),X[t].chat.window.buttonSend=j(),X[t].chat.window.textarea=_(e),$(X[t].chat.window.header).append(X[t].chat.window.iconClose),$(X[t].chat.window.header).append(X[t].chat.window.title),$(X[t].chat.window.panel).append(X[t].chat.window.header),$(X[t].chat.window.panel).append(X[t].chat.window.body),$(X[t].chat.window.form).append(X[t].chat.window.textarea),$(X[t].chat.window.form).append(X[t].chat.window.buttonSend),$(X[t].chat.window.footer).append(X[t].chat.window.form),$(X[t].chat.window.panel).append(X[t].chat.window.footer),$("#"+K.areaWindowChatId).append(X[t].chat.window.panel),$(X[t].chat.window.panel).fadeIn(),X[t].chat.window._construct=!0,b(t)):$(X[t].chat.window.panel).is(":visible")||$(X[t].chat.window.panel).fadeIn(),X[t].chat.visible=!0,X[t].badge.text=null,X[t].badge.innerText=null,g(t),$(X[t].chat.window.textarea).focus(),S(e)}catch(s){console.log(s)}}function m(e){try{var t=JSON.parse(e),s=parseInt(t.from),n=new Array(t);if(f(s,n),X[s].chat.visible!==!0){var a=""!==$(X[s].badge).text()?parseInt(X[s].badge.innerText):0;a++,X[s].badge.innerText=a.toString(),X[s].alertMsg=k(),$("#"+K.divInnerMenuContatos).find("audio").remove(),$("#"+K.divInnerMenuContatos).append(X[s].alertMsg)}else t.sessionId=t.sessionId_from,t.userId=t.from,S(t)}catch(o){console.log(o)}}function f(e,t){try{for(var s=0;s<t.length;s++){var n=parseInt(t[s].from)===parseInt(K.userId)?!0:!1,a=X[e].chat.message.length;X[e].chat.message[a]={from:parseInt(t[s].from),text:q(t[s],n),data:D(t[s],n),read:t[s].read===!0&&parseInt(t[s].from)===parseInt(K.userId)?P():null},$(X[e].chat.window.body).append(X[e].chat.message[a].text),$(X[e].chat.message[a].data).append(X[e].chat.message[a].read),$(X[e].chat.window.body).append(X[e].chat.message[a].data)}g(e)}catch(o){console.log(o)}}function h(e){try{for(var t=0;t<e.length;t++)$.ajax({url:K.url,data:{to:e[t].to,from:e[t].from,message:e[t].message,process:"saveMessage"},method:"POST",dataType:"JSON",success:function(e){e.ok===!0},error:function(e){console.log(e)}})}catch(s){console.log(s)}}function w(e,t){try{$.ajax({url:K.url,data:{to:t,from:e,process:"setReadMessage"},method:"POST",dataType:"JSON",success:function(e){e.ok===!0},error:function(e){console.log(e)}})}catch(s){console.log(s)}}function g(e){try{var t=X[e].chat.window.body;$(t).scrollTop($(t)[0].scrollHeight)}catch(s){console.log(s)}}function I(e){try{var t=parseInt(e.userId),s=$(X[t].chat.window.textarea).val();if($(X[t].chat.window.textarea).val(""),"\n"!==s[0]&&"\r"!==s[0]){var n=new Object;n.read=!1,n.message=y(s),n.from=K.userId,n.to=t,n.data=(new moment).format("DD-MM-YYYY HH:mm"),n.sessionId_from=a(),n.sessionId_to=X[t].sessionId,Q.call("message",JSON.stringify(n));var o=new Array(n);h(o),f(t,o)}return!1}catch(s){return console.log(s),!1}}function y(e){return e=e.replace("\n",""),e=e.replace("\r","")}function v(e){try{var t=parseInt(e.userId);$(X[t].chat.window.panel).is(":visible")&&($(X[t].chat.window.panel).fadeOut(),X[t].chat.visible=!1)}catch(s){console.log(s)}}function b(e){try{$.ajax({url:K.url,data:{userId:K.userId,from:e,qtdMessages:K.qtdMessages,process:"getMessages"},method:"POST",dataType:"JSON",success:function(t){t.length&&f(e,t)},error:function(e){console.log(e)}})}catch(t){console.log(t)}}function S(e){if(w(e.userId,K.userId),null!==e.sessionId){var t=new Object;t.sessionId_to=parseInt(e.sessionId),t.sessionId_from=a(),t.to=parseInt(K.userId),t.from=parseInt(e.userId),t.read=!0,Q.call("readMessage",JSON.stringify(t))}}function x(e){try{for(var t=JSON.parse(e),s=parseInt(t.to),n=0;n<X[s].chat.message.length;n++)parseInt(X[s].chat.message[n].from)===parseInt(K.userId)&&(null===X[s].chat.message[n].read&&(X[s].chat.message[n].read=P()),$(X[s].chat.message[n].data).append(X[s].chat.message[n].read).fadeIn())}catch(a){console.log(a)}}function C(e){try{var t={status:{sessionId:a(),userId:K.userId,status:$(e).val()}};Q.publish("changeStatus",JSON.stringify(t))}catch(s){console.log(s)}}function E(e){var t=document.createElement("button");return t.style.display="inline-block",t.innerText=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t.text=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t["class"]=K.buttonClassInitChat,t.className=K.buttonClassInitChat,t.classList=K.buttonClassInitChat,t.value=e.sessionId,t.id=e.userId,t.type="button",t.onclick=function(){p(e)},t}function k(){var e=document.createElement("audio");e.autoplay=!0,e.loop=!1,e.style.display="none";var t=document.createElement("source");return t.src=K.sound_mensagem,t.type="audio/mp3",$(e).append(t),e}function N(e){var t=document.createElement("span");return t.innerText=parseInt(e)>0?e:null,t["class"]=K.classBadge,t.className=K.classBadge,t.classList=K.classBadge,t.style.backgroundColor=K.colorBadge,t}function O(){var e=document.createElement("select");e.name="selectStatus",e["class"]=K.selectClassStatus,e.className=K.selectClassStatus,e.classList=K.selectClassStatus,e.onchange=function(){C($(this))};for(var t=0;t<K.optionsStatus.length;t++){var s=document.createElement("option");s.value=K.optionsStatus[t].text,s.text=K.optionsStatus[t].text+" ",s.label=K.optionsStatus[t].text+" ",s.selected="online"===K.optionsStatus[t].text?!0:!1,$(s).append(T(K.optionsStatus[t].text)),$(e).append(s)}return e}function T(e){var t=document.createElement("i");t.nodeName="I",t.name="i";for(var s=0;s<K.optionsStatus.length;s++)if(e===K.optionsStatus[s].text){t["class"]=K.optionsStatus[s].icon,t.className=K.optionsStatus[s].icon,t.classList=K.optionsStatus[s].icon,t.style.color=K.optionsStatus[s].color,t.title=K.optionsStatus[s].text;break}return t}function L(){var e=document.createElement("div");return e["class"]=K.windowClass.panel,e.className=K.windowClass.panel,e.classList=K.windowClass.panel,e.style.zIndex="999",e.style.position="relative",e.style["float"]="right",e.style.width="300px",e.style.margin="10px",e}function M(){var e=document.createElement("div");return e["class"]=K.windowClass.header,e.className=K.windowClass.header,e.classList=K.windowClass.header,e.style.textOverflow="ellipsis",e}function J(e){var t=document.createElement("h3");return t["class"]=K.windowClass.title,t.className=K.windowClass.title,t.classList=K.windowClass.title,t.text=""!==e.nick?e.nick+" - "+e.nome:e.nome,t.innerText=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t.innerText=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t.style.width="250px",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t.style.overflow="hidden",t.style.textAlign="left",t}function R(){var e=document.createElement("div");return e["class"]=K.windowClass.body,e.className=K.windowClass.body,e.classList=K.windowClass.body,e.style.overflowY="auto",e.style.overflowX="hidden",e.style.height="270px",e}function B(){var e=document.createElement("div");return e["class"]=K.windowClass.footer,e.className=K.windowClass.footer,e.classList=K.windowClass.footer,e.style.padding="0px",e.style.height="90px",e}function A(e){var t=document.createElement("form");return t.name="sendMsg",t.onsubmit=function(){return I(e),!1},t}function _(e){var t=document.createElement("textarea");return t.onkeyup=function(){return 13===window.event.keyCode?($(this).parents("form").submit(),!1):void 0},t.required="required",t.name="msg",t.cols="10",t.rows="3",t.style.position="relative",t.style.width="70%",t.style.height="75px",t.style.resize="none",t.style.border="none",t.style.backgroundColor="#f5f5f5",t.style.outline="none",t.style.padding="7px",t}function F(e){var t=document.createElement("i");return t["class"]=K.windowClass.close,t.className=K.windowClass.close,t.classList=K.windowClass.close,t.title="Fechar",t.style.position="absolute",t.style.right="10px",t.style.top="10px",t.style.cursor="pointer",t.onclick=function(){v(e)},t}function j(){var e=document.createElement("button");e.type="submit",e["class"]=K.classButtonSend,e.className=K.classButtonSend,e.classList=K.classButtonSend,e.title="Enviar",e.style.position="absolute",e.style.right="0px",e.style.bottom="0px",e.style.width="30%",e.style.height="90px";var t=document.createElement("i");return t["class"]=K.windowClass.iconSend,t.className=K.windowClass.iconSend,t.classList=K.windowClass.iconSend,t.style.color=K.windowClass.sendColor,$(e).append(t),e}function q(e,t){var s=document.createElement("div"),n=document.createElement("label");return n.innerText=e.message,n.text=e.message,n.style.padding="6px",n.style.wordWrap="break-word",t===!0?(n["class"]=K.labelSendClass,n.classList=K.labelSendClass,n.className=K.labelSendClass,n.style.color=K.labelSendColor,s.style.textAlign="left",n.style.borderRadius="0px 10px 10px 10px"):(n["class"]=K.labelReceiveClass,n.classList=K.labelReceiveClass,n.className=K.labelReceiveClass,n.style.color=K.labelReceiveColor,s.style.textAlign="right",n.style.borderRadius="10px 0px 10px 10px"),$(s).append(n),s}function D(e,t){var s=document.createElement("div");return s.innerText=e.data+" ",s.text=e.data+" ",s.style.fontSize="0.8em",s.style.marginBottom="10px",t===!0?s.style.textAlign="left":s.style.textAlign="right",s}function P(){var e=document.createElement("i");return e["class"]=K.iconRead,e.classList=K.iconRead,e.className=K.iconRead,e.style.color=K.iconReadColor,e}function Y(){try{W();var e=document.createElement("div");$(e).addClass(K["class"]);var t=document.createElement("ul");X.forEach(function(e){if(parseInt(e.userId)!==parseInt(K.userId)){var s=document.createElement("div");s.style.textOverflow="ellipsis",$(s).append(e.badge),$(s).append(e.button),$(s).append(e.i);var n=document.createElement("li");$(n).append(s),$(t).append(n)}}),$(e).append(t);var s=$("#"+K.divInnerMenuContatos);$(s).html(O()),$(s).append(e).fadeIn(),$(s).addClass(K["class"])}catch(n){console.log(n)}}function W(){var e=document.createElement("div");e.style.position="fixed",e.style.right="0px",e.style.bottom="0px",e.id=K.areaWindowChatId,$("body").append(e)}function z(e){try{var t=document.createElement("div");t["class"]=K.errorClass,t.className=K.errorClass,t.classList=K.errorClass;var s=document.createElement("p");s.innerText=e,s.text=e,$(t).append(s),$("body").append(t).fadeIn(),setTimeout(H,K.setTimeOut,t)}catch(e){console.log(e)}}function H(e){$(e).remove()}var U=null,X=null,G={ws:"https:"===window.location.protocol?"wss://localhost:8080/Chat":"ws://localhost:8080/Chat",userId:null,url:"src/Controler/chatControler.php",qtdMessages:30,buttonClassInitChat:"btn btn-link",classButtonSend:"btn btn-default",selectClassStatus:"btn btn-primary",iconRead:"fa fa-check-circle",iconReadColor:"#5CB85C",optionsStatus:[{text:"online",icon:"fa fa-commenting",color:"#1EFF1E"},{text:"offline",icon:"fa fa-power-off",color:"#EC925B"},{text:"ocupado",icon:"fa fa-pencil-square-o",color:"#777777"}],"class":"chat",classBadge:"badge",colorBadge:"#EC925B",errorClass:"erroChat",setTimeOut:5e3,labelReceiveColor:"#FFF",labelSendColor:"#FFF",labelReceiveClass:"label-info",labelSendClass:"label-warning",sound_mensagem:"./src/Chat/sound_mensagem.mp3",windowClass:{panel:"panel panel-primary",header:"panel-heading",body:"panel-body",footer:"panel-footer",title:"panel-title",close:"fa fa-times",iconSend:"fa fa-3x fa-chevron-right",sendColor:""},areaWindowChatId:"windowChatArea",divInnerMenuContatos:"chat"},K=$.extend({},G,e),Q=new ab.Session(K.ws,function(){Q.subscribe("online",t),Q.subscribe("desconectar",t),Q.subscribe("conectar",t),Q.subscribe("changeStatus",t),Q.subscribe("onError",t),Q.subscribe("message",t),Q.subscribe("readMessage",t),Q.publish("online",s()),console.log("CONECTAD0")},function(){console.warn("DESCONECTADO")},{skipSubprotocolCheck:!1});return this}