function chat_init(e){function t(e,t){switch(e){case"online":null===U&&(U=o(t),K.publish("conectar",s()));break;case"conectar":null===H&&(H=n(t)),i(t);break;case"desconectar":d(t);break;case"changeStatus":c(t);break;case"message":f(t);break;case"readMessage":x(t);break;case"onError":u(t)}}function s(){var e={conectar:{userId:G.userId,status:"online"}};return JSON.stringify(e)}function n(e){var t=JSON.parse(e);return parseInt(t.sessionId)}function a(){return parseInt(H)}function o(e){try{$.ajax({url:G.url,data:{userId:G.userId,process:"selectUsers"},method:"POST",dataType:"JSON",success:function(t){null!==t&&(l(t),r(e))},error:function(e){console.log(e)}})}catch(t){console.log(t)}}function l(e){try{U=new Array;for(var t=0;t<e.length;t++){var s=new Object;s.sessionId=null,s.userId=e[t].userId,s.nome=e[t].nome,s.nick=e[t].nick,s.status="offline",s.button=null,s.i=null,s.badge=k(e[t].msgNotRead),s.chat={visible:!1,window:{_construct:!1,panel:null,header:null,title:null,body:null,footer:null,form:null,textarea:null,buttonSend:null,iconClose:null},message:[{from:null,text:null,read:null,data:null}]},U[parseInt(e[t].userId)]=s}}catch(n){console.log(n)}}function r(e){try{var t=JSON.parse(e),s=$(t).toArray();U.forEach(function(e){s.forEach(function(t){for(var s=0;s<t.length;s++)parseInt(e.userId)===parseInt(t[s].userId)&&(e.status=t[s].status,e.sessionId=t[s].sessionId)}),e.button=E(e),e.i=O(e.status)}),P()}catch(n){console.log(n)}}function i(e){try{var t=JSON.parse(e),s=parseInt(t.userId);if(parseInt(H)!==parseInt(t.sessionId))if("offline"===t.status)d(e);else for(var n=0;n<G.optionsStatus.length;n++)if(G.optionsStatus[n].text===t.status){U[s].sessionId=t.sessionId,U[s].button.value=t.sessionId,U[s].status=t.status,U[s].i["class"]=G.optionsStatus[n].icon,U[s].i.className=G.optionsStatus[n].icon,U[s].i.classList=G.optionsStatus[n].icon,U[s].i.style.color=G.optionsStatus[n].color,U[s].i.title=G.optionsStatus[n].text;break}}catch(a){console.log(a)}}function c(e){try{var t=JSON.parse(e),s=parseInt(t.userId);if(parseInt(H)!==parseInt(t.sessionId)&&parseInt(U[s].sessionId)===parseInt(t.sessionId))for(var n=0;n<G.optionsStatus.length;n++)if(G.optionsStatus[n].text===t.status){U[s].i["class"]=G.optionsStatus[n].icon,U[s].i.className=G.optionsStatus[n].icon,U[s].i.classList=G.optionsStatus[n].icon,U[s].i.style.color=G.optionsStatus[n].color,U[s].i.title=G.optionsStatus[n].text;break}}catch(a){console.log(a)}}function d(e){try{var t=JSON.parse(e),s=parseInt(t.desconectar.userId);if(parseInt(G.userId)!==parseInt(t.desconectar.userId)&&parseInt(U[s].sessionId)===parseInt(t.desconectar.sessionId))for(var n=0;n<G.optionsStatus.length;n++)if(G.optionsStatus[n].text===t.desconectar.status){U[s].sessionId=null,U[s].i["class"]=G.optionsStatus[n].icon,U[s].i.className=G.optionsStatus[n].icon,U[s].i.classList=G.optionsStatus[n].icon,U[s].i.style.color=G.optionsStatus[n].color,U[s].i.title=G.optionsStatus[n].text;break}}catch(a){console.log(a)}}function u(e){try{var t=JSON.parse(e),s=parseInt(t.onError.userId);if(a()===parseInt(t.onError.oldSessionId)){K.close(),U=null;var n="Usuário duplicado, sua conexão foi fechada !! Provavelmente este login está sendo usado em outro dispositivo.";W(n)}else if(parseInt(G.userId)!==parseInt(t.onError.userId)&&parseInt(U[s].sessionId)===parseInt(t.onError.oldSessionId)){U[s].sessionId=t.onError.sessionId,U[s].button.value=t.onError.sessionId;for(var o=0;o<G.optionsStatus.length;o++)t.onError.status===G.optionsStatus[o].text&&(U[s].i["class"]=G.optionsStatus[o].icon,U[s].i.className=G.optionsStatus[o].icon,U[s].i.classList=G.optionsStatus[o].icon,U[s].i.style.color=G.optionsStatus[o].color,U[s].i.title=G.optionsStatus[o].text)}}catch(n){console.log(n)}}function p(e){try{var t=parseInt(e.userId);U[t].chat.window._construct===!1?(U[t].chat.window.panel=T(e),U[t].chat.window.body=R(),U[t].chat.window.header=L(),U[t].chat.window.footer=B(),U[t].chat.window.title=J(e),U[t].chat.window.form=M(e),U[t].chat.window.iconClose=F(e),U[t].chat.window.buttonSend=_(),U[t].chat.window.textarea=A(e),$(U[t].chat.window.header).append(U[t].chat.window.iconClose),$(U[t].chat.window.header).append(U[t].chat.window.title),$(U[t].chat.window.panel).append(U[t].chat.window.header),$(U[t].chat.window.panel).append(U[t].chat.window.body),$(U[t].chat.window.form).append(U[t].chat.window.textarea),$(U[t].chat.window.form).append(U[t].chat.window.buttonSend),$(U[t].chat.window.footer).append(U[t].chat.window.form),$(U[t].chat.window.panel).append(U[t].chat.window.footer),$("#"+G.areaWindowChatId).append(U[t].chat.window.panel),$(U[t].chat.window.panel).fadeIn(),U[t].chat.window._construct=!0,v(t)):$(U[t].chat.window.panel).is(":visible")||$(U[t].chat.window.panel).fadeIn(),U[t].chat.visible=!0,U[t].badge.text=null,U[t].badge.innerText=null,I(t),$(U[t].chat.window.textarea).focus(),S(e)}catch(s){console.log(s)}}function f(e){try{var t=JSON.parse(e),s=parseInt(t.from),n=new Array(t);if(w(s,n),U[s].chat.visible!==!0){var a=""!==$(U[s].badge).text()?parseInt(U[s].badge.innerText):0;a++,U[s].badge.innerText=a.toString()}else t.sessionId=t.sessionId_from,t.userId=t.from,S(t)}catch(o){console.log(o)}}function w(e,t){try{for(var s=0;s<t.length;s++){var n=parseInt(t[s].from)===parseInt(G.userId)?!0:!1,a=U[e].chat.message.length;U[e].chat.message[a]={from:parseInt(t[s].from),text:j(t[s],n),data:q(t[s],n),read:t[s].read===!0&&parseInt(t[s].from)===parseInt(G.userId)?D():null},$(U[e].chat.window.body).append(U[e].chat.message[a].text),$(U[e].chat.message[a].data).append(U[e].chat.message[a].read),$(U[e].chat.window.body).append(U[e].chat.message[a].data)}I(e)}catch(o){console.log(o)}}function h(e){try{for(var t=0;t<e.length;t++)$.ajax({url:G.url,data:{to:e[t].to,from:e[t].from,message:e[t].message,process:"saveMessage"},method:"POST",dataType:"JSON",success:function(e){e.ok===!0},error:function(e){console.log(e)}})}catch(s){console.log(s)}}function m(e,t){try{$.ajax({url:G.url,data:{to:t,from:e,process:"setReadMessage"},method:"POST",dataType:"JSON",success:function(e){e.ok===!0},error:function(e){console.log(e)}})}catch(s){console.log(s)}}function I(e){try{var t=U[e].chat.window.body;$(t).scrollTop($(t)[0].scrollHeight)}catch(s){console.log(s)}}function g(e){try{var t=parseInt(e.userId),s=$(U[t].chat.window.textarea).val();if($(U[t].chat.window.textarea).val(""),"\n"!==s[0]&&"\r"!==s[0]){var n=new Object;n.read=!1,n.message=b(s),n.from=G.userId,n.to=t,n.data=(new moment).format("DD-MM-YYYY HH:mm"),n.sessionId_from=a(),n.sessionId_to=U[t].sessionId,K.call("message",JSON.stringify(n));var o=new Array(n);h(o),w(t,o)}return!1}catch(s){return console.log(s),!1}}function b(e){return e=e.replace("\n",""),e=e.replace("\r","")}function y(e){try{var t=parseInt(e.userId);$(U[t].chat.window.panel).is(":visible")&&($(U[t].chat.window.panel).fadeOut(),U[t].chat.visible=!1)}catch(s){console.log(s)}}function v(e){try{$.ajax({url:G.url,data:{userId:G.userId,from:e,qtdMessages:G.qtdMessages,process:"getMessages"},method:"POST",dataType:"JSON",success:function(t){t.length&&w(e,t)},error:function(e){console.log(e)}})}catch(t){console.log(t)}}function S(e){if(m(e.userId,G.userId),null!==e.sessionId){var t=new Object;t.sessionId_to=parseInt(e.sessionId),t.sessionId_from=a(),t.to=parseInt(G.userId),t.from=parseInt(e.userId),t.read=!0,K.call("readMessage",JSON.stringify(t))}}function x(e){try{for(var t=JSON.parse(e),s=parseInt(t.to),n=0;n<U[s].chat.message.length;n++)parseInt(U[s].chat.message[n].from)===parseInt(G.userId)&&(null===U[s].chat.message[n].read&&(U[s].chat.message[n].read=D()),$(U[s].chat.message[n].data).append(U[s].chat.message[n].read).fadeIn())}catch(a){console.log(a)}}function C(e){try{var t={status:{sessionId:a(),userId:G.userId,status:$(e).val()}};K.publish("changeStatus",JSON.stringify(t))}catch(s){console.log(s)}}function E(e){var t=document.createElement("button");return t.style.display="inline-block",t.innerText=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t.text=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t["class"]=G.buttonClassInitChat,t.className=G.buttonClassInitChat,t.classList=G.buttonClassInitChat,t.value=e.sessionId,t.id=e.userId,t.type="button",t.onclick=function(){p(e)},t}function k(e){var t=document.createElement("span");return t.innerText=parseInt(e)>0?e:null,t["class"]=G.classBadge,t.className=G.classBadge,t.classList=G.classBadge,t.style.backgroundColor=G.colorBadge,t}function N(){var e=document.createElement("select");e.name="selectStatus",e["class"]=G.selectClassStatus,e.className=G.selectClassStatus,e.classList=G.selectClassStatus,e.onchange=function(){C($(this))};for(var t=0;t<G.optionsStatus.length;t++){var s=document.createElement("option");s.value=G.optionsStatus[t].text,s.text=G.optionsStatus[t].text+" ",s.label=G.optionsStatus[t].text+" ",s.selected="online"===G.optionsStatus[t].text?!0:!1,$(s).append(O(G.optionsStatus[t].text)),$(e).append(s)}return e}function O(e){var t=document.createElement("i");t.nodeName="I",t.name="i";for(var s=0;s<G.optionsStatus.length;s++)if(e===G.optionsStatus[s].text){t["class"]=G.optionsStatus[s].icon,t.className=G.optionsStatus[s].icon,t.classList=G.optionsStatus[s].icon,t.style.color=G.optionsStatus[s].color,t.title=G.optionsStatus[s].text;break}return t}function T(){var e=document.createElement("div");return e["class"]=G.windowClass.panel,e.className=G.windowClass.panel,e.classList=G.windowClass.panel,e.style.zIndex="999",e.style.position="relative",e.style["float"]="right",e.style.width="300px",e.style.margin="10px",e}function L(){var e=document.createElement("div");return e["class"]=G.windowClass.header,e.className=G.windowClass.header,e.classList=G.windowClass.header,e.style.textOverflow="ellipsis",e}function J(e){var t=document.createElement("h3");return t["class"]=G.windowClass.title,t.className=G.windowClass.title,t.classList=G.windowClass.title,t.text=""!==e.nick?e.nick+" - "+e.nome:e.nome,t.innerText=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t.innerText=""!==e.nick&&null!==e.nick?e.nick+" - "+e.nome:e.nome,t.style.width="250px",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t.style.overflow="hidden",t.style.textAlign="left",t}function R(){var e=document.createElement("div");return e["class"]=G.windowClass.body,e.className=G.windowClass.body,e.classList=G.windowClass.body,e.style.overflowY="auto",e.style.overflowX="hidden",e.style.height="270px",e}function B(){var e=document.createElement("div");return e["class"]=G.windowClass.footer,e.className=G.windowClass.footer,e.classList=G.windowClass.footer,e.style.padding="0px",e.style.height="90px",e}function M(e){var t=document.createElement("form");return t.name="sendMsg",t.onsubmit=function(){return g(e),!1},t}function A(){var e=document.createElement("textarea");return e.onkeyup=function(){return 13===window.event.keyCode?($(this).parents("form").submit(),!1):void 0},e.required="required",e.name="msg",e.cols="10",e.rows="3",e.style.position="relative",e.style.width="70%",e.style.height="75px",e.style.resize="none",e.style.border="none",e.style.backgroundColor="#f5f5f5",e.style.outline="none",e.style.padding="7px",e}function F(e){var t=document.createElement("i");return t["class"]=G.windowClass.close,t.className=G.windowClass.close,t.classList=G.windowClass.close,t.title="Fechar",t.style.position="absolute",t.style.right="10px",t.style.top="10px",t.style.cursor="pointer",t.onclick=function(){y(e)},t}function _(){var e=document.createElement("button");e.type="submit",e["class"]=G.classButtonSend,e.className=G.classButtonSend,e.classList=G.classButtonSend,e.title="Enviar",e.style.position="absolute",e.style.right="0px",e.style.bottom="0px",e.style.width="30%",e.style.height="90px";var t=document.createElement("i");return t["class"]=G.windowClass.iconSend,t.className=G.windowClass.iconSend,t.classList=G.windowClass.iconSend,t.style.color=G.windowClass.sendColor,$(e).append(t),e}function j(e,t){var s=document.createElement("div"),n=document.createElement("label");return n.innerText=e.message,n.text=e.message,n.style.padding="6px",n.style.wordWrap="break-word",t===!0?(n["class"]=G.labelSendClass,n.classList=G.labelSendClass,n.className=G.labelSendClass,n.style.color=G.labelSendColor,s.style.textAlign="left",n.style.borderRadius="0px 10px 10px 10px"):(n["class"]=G.labelReceiveClass,n.classList=G.labelReceiveClass,n.className=G.labelReceiveClass,n.style.color=G.labelReceiveColor,s.style.textAlign="right",n.style.borderRadius="10px 0px 10px 10px"),$(s).append(n),s}function q(e,t){var s=document.createElement("div");return s.innerText=e.data+" ",s.text=e.data+" ",s.style.fontSize="0.8em",s.style.marginBottom="10px",s.style.textAlign=t===!0?"left":"right",s}function D(){var e=document.createElement("i");return e["class"]=G.iconRead,e.classList=G.iconRead,e.className=G.iconRead,e.style.color=G.iconReadColor,e}function P(){try{Y();var e=document.createElement("div");$(e).addClass(G["class"]);var t=document.createElement("ul");U.forEach(function(e){if(parseInt(e.userId)!==parseInt(G.userId)){var s=document.createElement("div");s.style.textOverflow="ellipsis",$(s).append(e.badge),$(s).append(e.button),$(s).append(e.i);var n=document.createElement("li");$(n).append(s),$(t).append(n)}}),$(e).append(t);var s=$("#"+G.divInnerMenuContatos);$(s).html(N()),$(s).append(e).fadeIn(),$(s).addClass(G["class"])}catch(n){console.log(n)}}function Y(){var e=document.createElement("div");e.style.position="fixed",e.style.right="0px",e.style.bottom="0px",e.id=G.areaWindowChatId,$("body").append(e)}function W(e){try{var t=document.createElement("div");t["class"]=G.errorClass,t.className=G.errorClass,t.classList=G.errorClass;var s=document.createElement("p");s.innerText=e,s.text=e,$(t).append(s),$("body").append(t).fadeIn(),setTimeout(z,G.setTimeOut,t)}catch(e){console.log(e)}}function z(e){$(e).fadeOut()}var H=null,U=null,X={ws:"https:"===window.location.protocol?"wss://localhost:8080/Chat":"ws://localhost:8080/Chat",userId:null,url:"src/Controler/chatControler.php",qtdMessages:30,buttonClassInitChat:"btn btn-link",classButtonSend:"btn btn-default",selectClassStatus:"btn btn-primary",iconRead:"fa fa-check-circle",iconReadColor:"#5CB85C",optionsStatus:[{text:"online",icon:"fa fa-commenting",color:"#1EFF1E"},{text:"offline",icon:"fa fa-power-off",color:"#EC925B"},{text:"ocupado",icon:"fa fa-pencil-square-o",color:"#777777"}],"class":"chat",classBadge:"badge",colorBadge:"#EC925B",errorClass:"erroChat",setTimeOut:5e3,labelReceiveColor:"#FFF",labelSendColor:"#FFF",labelReceiveClass:"label-info",labelSendClass:"label-warning",windowClass:{panel:"panel panel-primary",header:"panel-heading",body:"panel-body",footer:"panel-footer",title:"panel-title",close:"fa fa-times",iconSend:"fa fa-3x fa-chevron-right",sendColor:""},areaWindowChatId:"windowChatArea",divInnerMenuContatos:"chat"},G=$.extend({},X,e),K=new ab.Session(G.ws,function(){K.subscribe("online",t),K.subscribe("desconectar",t),K.subscribe("conectar",t),K.subscribe("changeStatus",t),K.subscribe("onError",t),K.subscribe("message",t),K.subscribe("readMessage",t),K.publish("online",s()),console.log("CONECTAD0")},function(){console.warn("DESCONECTADO")},{skipSubprotocolCheck:!1});return this}